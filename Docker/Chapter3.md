# 03. 도커 스웜
## 3.1 도커 스웜을 사용하는 이유
하나의 호스트 머신에서 도커 엔진을 구동하다가 CPU나 메모리, 디스크 용량과 같은 자원이 부족한 경우
- 가장 간단한 해답: 매우 성능이 좋은 서버를 새로 산다 -> 비용 측면에서 좋은 해답이 아님
- 가장 많이 사용하는 방법: 여러 대의 서버를 클러스터로 만들어 자원을 병렬로 확장하는 것

**but**, 여러대의 서버를 하나의 자원 풀로 만드는 것은 쉬운 작업이 아니다. 

문제점 
- 새로운 서버나 컨테이너가 추가됬을 때 발견하는 작업 필요
- 컨테이너를 어떤 서버에 할당 할서인가에 대한 스케줄러와 로드밸런스 문제
- 클러스터 내의 서버가 다운 됐을 때 고가용성(High Availability)을 어떻게 보장할지 등

대표적인 해결 방안은 도커에서 공식적으로 제공하는 <u>**도커 스웜(docker swarm)**</u>과 <u>**스웜 모드(swarm mode)**</u> 이다.

## 3.2 스웜 클래식과 도커 스웜 모드
도커 스웜의 장점
- 여러 대의 도커 서버를 하나의 클러스터로 만들어 컨테이너를 생성하는 여러기능을 제공한다.
- 다양한 전략을 세워 컨테이너를 특정 도커 서버에 할당 및 유동적으로 서버를 확장할 수 있다.
- 스웜 클러스터에 등록된 서버의 컨테이너를 쉽게 관리할 수 있다.

#### 도커 스웜의 종류

##### 1. 스웜 클래식 (Legacy)
- 도커 버전 1.6 이후 부터 사용할 수 있는 컨테이너로서의 스웜
- **목적**: 여러 대의 도커 서버를 하나의 지점에서 사용하도록 단일 접근점을 제공
- docker run, docker ps 등 일반적인 도커 명령어와 도커 API로 클러스터의 서버를 제어 및 관리
- 분산 코디네이터, 에이전트 등이 별도 실행

*분산 코디네이터(Distributed Coordinator): 클러스터에 영입할 새로운 서버의 발견, 클러스터의 각종 설정 저장, 데이터 동기화 등에 주로 이용 (ex. etcd, zookeeper, consul 등)

##### 2. 도커 스웜 모드
 - 도커 버전 1.12 이후부터 사용 가능
 - **목적**: 마이크로서비스 아키텍처의 컨테이너를 다루기 위한 클러스링 기능에 초점
 - 같은 컨테이너를 동시에 여러 개 생성해 필요에 따라 유동적으로 컨테이너의 수를 조절 가능
 - 컨테이너로의 연결을 분산하는 로드밸런싱 기능을 지원
 - 클러스터링을 위한 모든 도구가 도커 엔진 자체에 내장 되어 있어 쉽게 서버 클러스터 구축이 가능
 
 -> 서비스 확장성과 안정성 등 여러 측면에서 스웜 클래식보다 뛰어나기 때문에 일반적으로는 스웜 모드를 더 많이 사용한다.
 
## 3.3 스웜 모드
스웜 모드는 별도의 설치 과정이 필요하지 않으며 도커 엔진 자체에 내장되어있다.

도커 엔진의 스웜 모드 클러스터 정보 확인
```
 docker info | grep Swarm
 Swarm: inactive // 비활성 상태
```

### 3.3.1 도커 스웜 모드의 구조
> 도커 스웜 모드 = 매니저노드 + 워커 노드

- 워커 노드: 실제로 컨테이너가 생성되고 관리되는 도커 서버
- 매니저 노드: 워커 노드를 관리 하기 위한 도커 서버 (워커 노드의 역할 포함 -> 컨테이너 생성 가능)
- 매니저 노드는 1개 이상 있어야 하지만 워커 노드는 없을 수도 있다. -> 매니저 노드가 워커 노드의 역할도 포함하고 있기 때문

##### 권장 사항
- 워커 노드와 매니저 노드를 구분해서 사용
- 매니저 노드의 다중화 -> 매니저의 부하를 분산 시키고 특정 매니저 노드가 다운됐을 때 정상적으로 스웜 클러스터를 유지할 수 있기 때문
- 홀수 개의 매니저로 구성
    - 스웜 모드는 매니저 노드의 절반 이상에 장애가 생겨 정상적으로 작동하지 못할 경우 클러스터의 운영을 중단한다.
    - 네트워크 파티셔닝과 같은 현상이 발생했을 경우, 짝수 개의 매니저로 구성한 클러스터는 운영이 중단될 수도 있지만 홀수 개로 구성했을 경우에는 과반수 이상이 유지되는 쿼럼 매니저에서 운영을 계속할 수 있다. 
    

### 3.3.2 도커 스웜 모드 클러스터 구축

##### 매니저 노드의 IP 주소 입력 (다른 도커 서버가 매니저 노드에 접근하기 위한 IP 주소)
```
> docker swarm init --advertise-addr 192.168.0.100
Swarm initialized: current node (3l82vvc581b8myfrvptgbkvxd) is now a manager.

To add a worker to this swarm, run the following command:

    docker swarm join --token SWMTKN-1-25h3p12m90lv93l0arf9y0cq6z31a34nro5c3ngr9ysyoix18e-4me7bvztfjh9142g5oed1ibjj 192.168.0.100:2377

To add a manager to this swarm, run 'docker swarm join-token manager' and follow the instructions.
```
- `docker swarm join` 명령어: 새로운 워커 노드를 스웜 클러스터에 추가할 때 사용
- `--token`: 새로운 노드를 해당 스웜 클러스터에 추가하기 위한 비밀키
- 스웜 매니저는 기본적으로 `2377`번 포트를 사용 


작성 중 - ing